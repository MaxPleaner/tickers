$(function(){curry=function(e){var t=[].slice,n=t.call(arguments,1);return function(){return e.apply(this,n.concat(t.call(arguments)))}},Style={createStylesheet:function(){var e=document.createElement("style");return e.appendChild(document.createTextNode("")),document.head.appendChild(e),e.sheet},stylesheet:function(){return this._stylesheet?this._stylesheet:(this._stylesheet=this.createStylesheet(),this._stylesheet)},addCSSRule:function(e,t,n){var i=this.stylesheet();"insertRule"in i?i.insertRule(e+"{"+t+"}",n):"addRule"in i&&i.addRule(e,t,n)}},getBindingTags=function(e){var t=[];return bindingTags=$(e).find("[binding-tag]"),$.each(bindingTags,function(e,n){var i=$(n),a=i.attr("binding-tag"),r=a.split(","),o=r[0],d=r[1],s=r[2];t.push({dom_elements:$("*[binding-tag='"+a+"']"),model_name:o,id:d,attribute:s})}),t},initBindings=function(e){$.each(e,function(e,t){var n=t.dom_elements,i=t.model_name,a=t.id,r=t.attribute,o=channels[i];o.bind(i+"-"+a+"-"+r+"-update",curry(updateElement,n))})},updateElement=function(e,t){e.val(t),e.attr("value",t),e.text(t)},addElement=function(e,t){e.append($("<div>").append(t.clone()).html())},deserialize=function(e){return JSON.parse(e)},processNewRecords=function(e){e=$.makeArray(e),e.forEach(function(e){e=deserialize(e),model_name=e.record_class,$container=$("."+model_name+"-index"),$template=$container.find("[template]"),$templateClone=cloneTemplate($template,e),$templateClone.removeAttr("template"),$templateClone.attr("record-id",model_name+","+e.id),addElement($container,$templateClone),initBindings(getBindingTags($templateClone)),initToggleInitialState($templateClone),processUpdateRecords(JSON.stringify(e))})},cloneTemplate=function(e,t){e=e.clone(),templateAttrs=e.find("[template-attr]");var n=t.id;return $.each(templateAttrs,function(e,i){var a=$(i),r=t.record_class,o=a.attr("template-attr");a.text(t[o]),a.val(t[o]),a.removeAttr("template-attr"),a.attr("binding-tag",r+","+n+","+o)}),e},findMatchingNodes=function(e,t){return $("*[record-id='"+e+","+t)},processUpdateRecords=function(e){e=$.makeArray(e),e.forEach(function(e){e=deserialize(e),model_name=e.record_class,id=e.id;for(var t in e){var n=e[t];console.log(e);var i=model_name+","+id+","+t;channels[model_name].trigger(model_name+"-"+id+"-"+t+"-update",n),updateElement($("[binding-tag='"+i+"']"),n)}})},processDestroyRecords=function(e){e=$.makeArray(e),e.forEach(function(e){e=deserialize(e),$matchingNodes=findMatchingNodes(e.record_class,e.id),$matchingNodes.remove()})},initFormBindings=function(e){e||(e="*"),$(document).on("submit",e+" form",function(e){var t=$(e.currentTarget);if(t[0].hasAttribute("skip-sockets"))return!0;e.preventDefault();var n=t.serialize(),i=t.attr("action"),a=t.attr("method"),r=t.find("[name=_method]");return r.length>0&&(a=r.val()),$.ajax({url:i,method:a,data:n}),!1})},initToggleInitialState=function(e){var t=$(e).find("[toggles]");$.each(t,function(e,t){var n=$(t),i=n.attr("toggles"),a=n.siblings(i);a.hide(),n.attr("hiding","")})},initTogglerListeners=function(e){$(document).on("click",e+" [toggles]",function(e){var t=$(e.currentTarget),n=t.attr("toggles"),i=t.siblings(n);t[0].hasAttribute("hiding")?(t.removeAttr("hiding"),i.show()):(t.attr("hiding",""),i.hide())})},initServerSeeds=function(){$.each($("[init]"),function(e,t){var n=$(t),i=(n.attr("init"),n.text()),a=deserialize(i);a.forEach(function(e){processNewRecords(JSON.stringify(e))}),n.hide()})},SocketHelpers={addedHooks:[],initialize:function(e,t){return Style.addCSSRule("[template]","display: none"),dispatcher=new WebSocketRails(t),channels={},e.forEach(function(e){var t=e;channels[t]=dispatcher.subscribe(t);var n=channels[t];n.bind("create",processNewRecords),n.bind("update",processUpdateRecords),n.bind("destroy",processDestroyRecords)}),initBindings(getBindingTags("*")),initFormBindings("*"),initToggleInitialState("*"),initTogglerListeners("*"),initServerSeeds(),dispatcher}}});